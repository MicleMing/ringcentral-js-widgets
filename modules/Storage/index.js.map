{"version":3,"sources":["modules/Storage/index.js"],"names":["DEFAULT_DISABLE_ALLOW_INACTIVE_TABS_WRITE","Storage","deps","dep","optional","disableAllowInactiveTabsWrite","auth","tabManager","options","name","_disableAllowInactiveTabsWrite","_auth","_tabManager","storedData","store","subscribe","loginStatus","loggedIn","ready","storageKey","prefix","ownerId","_storage","_StorageProvider","getData","key","_reducers","removeItem","dispatch","type","actionTypes","initSuccess","data","_storageHandler","value","sync","on","notLoggedIn","reset","off","destroy","resetSuccess","status","moduleStatuses","active","currentData","setItem","StorageBase"],"mappings":"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","file":"index.js","sourcesContent":["import { Module } from '../../lib/di';\nimport StorageBase from '../../lib/StorageBase';\nimport loginStatus from '../Auth/loginStatus';\nimport moduleStatuses from '../../enums/moduleStatuses';\n\nconst DEFAULT_DISABLE_ALLOW_INACTIVE_TABS_WRITE = false;\n\n/**\n * @class\n * @description Alternative implementation of the Storage class.\n *  Allows registeration of reducers so that persisted states can be computed with reducers.\n */\n@Module({\n  deps: [\n    'Auth',\n    { dep: 'TabManager', optional: true },\n    { dep: 'StorageOptions', optional: true },\n  ]\n})\nexport default class Storage extends StorageBase {\n  /**\n   * @constructor\n   * @param {Object} params - params object\n   * @param {disableAllowInactiveTabsWrite} params.disableAllowInactiveTabsWrite - disable Allow Inactive Tabs Write\n   * @param {Auth} params.auth - auth module instance\n   * @param {TabManager} params.tabManager - tabManager module instance\n   */\n  constructor({\n    disableAllowInactiveTabsWrite = DEFAULT_DISABLE_ALLOW_INACTIVE_TABS_WRITE,\n    auth,\n    tabManager,\n    ...options\n  }) {\n    super({\n      name: 'storage',\n      ...options,\n    });\n    this._disableAllowInactiveTabsWrite = disableAllowInactiveTabsWrite;\n    this._auth = auth;\n    this._tabManager = tabManager;\n  }\n  initialize() {\n    let storedData = null;\n    this.store.subscribe(async () => {\n      if (\n        this._auth.loginStatus === loginStatus.loggedIn &&\n        (!this._tabManager || this._tabManager.ready) &&\n        !this.ready\n      ) {\n        const storageKey =\n          `${this.prefix ? `${this.prefix}-` : ''}storage-${this._auth.ownerId}`;\n        this._storage = new this._StorageProvider({\n          storageKey,\n        });\n        storedData = await this._storage.getData();\n        for (const key in storedData) {\n          if (!this._reducers[key]) {\n            delete storedData[key];\n            await this._storage.removeItem(key);\n          }\n        }\n        this.store.dispatch({\n          type: this.actionTypes.initSuccess,\n          storageKey,\n          // To fix same reference in redux store with storedData\n          data: {\n            ...storedData,\n          },\n        });\n        this._storageHandler = ({ key, value }) => {\n          if (this.ready) {\n            storedData[key] = value;\n            this.store.dispatch({\n              type: this.actionTypes.sync,\n              key,\n              value,\n            });\n          }\n        };\n        this._storage.on('storage', this._storageHandler);\n      } else if (\n        (\n          (!!this._tabManager && !this._tabManager.ready) ||\n          this._auth.notLoggedIn\n        ) && this.ready\n      ) {\n        this.store.dispatch({\n          type: this.actionTypes.reset,\n        });\n        if (this._storageHandler) {\n          this._storage.off('storage', this._storageHandler);\n          this._storageHandler = null;\n        }\n        if (this._storage) {\n          this._storage.destroy();\n          this._storage = null;\n        }\n        this.store.dispatch({\n          type: this.actionTypes.resetSuccess,\n        });\n      }\n      if (\n        this.status === moduleStatuses.ready && (\n          !this._disableAllowInactiveTabsWrite ||\n          !this._tabManager ||\n          this._tabManager.active\n        )\n      ) {\n        // save new data to storage when changed\n        const currentData = this.data;\n        for (const key in currentData) {\n          if (storedData[key] !== currentData[key]) {\n            this._storage.setItem(key, currentData[key]);\n            storedData[key] = currentData[key];\n          }\n        }\n      }\n    });\n  }\n}\n"]}